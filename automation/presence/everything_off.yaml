- id: presence_everything_off
  alias: Turn everything off on presence state off
  description: ''
  mode: single
  trigger:
  - platform: state
    entity_id: input_boolean.presence
    from: 'on'
    to: 'off'
  condition: []
  action:
  # Lights
  - service: homeassistant.turn_off
    target:
      entity_id: group.all_lights_extra_group

  # Group devices
  - service: homeassistant.turn_off
    target:
      entity_id: group.devices_group

  - delay: 00:00:05

  # Desk and laptop
  - choose:
    - conditions:
      - condition: template
        value_template: >-
          {{
            is_state('device_tracker.lap_02_lan_router', 'not_home') and
            is_state('device_tracker.lap_02_wlan_router', 'not_home') and
            is_state('device_tracker.lap_work_router', 'not_home')
          }}
      sequence:
      - service: homeassistant.turn_off
        target:
          entity_id: group.desk_and_laptop_group
    default: []

  # Switch tower off
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ is_state("device_tracker.tower_lan_router", "not_home") }}'
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.tower
    default: []

  # Switches off
  - service: switch.turn_off
    target:
      entity_id:
        - switch.printer
        - switch.tv_switch
        - switch.tv_usb

  - choose:
    - conditions:
      - condition: template
        value_template: '{{ is_state("device_tracker.galaxy_a2_router", "not_home") }}'
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.nightstand_usb
    default: []
