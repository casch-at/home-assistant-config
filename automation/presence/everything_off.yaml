- id: presence_everything_off
  alias: Turn everything off on presence state off
  description: ''
  mode: single
  trigger:
  - platform: state
    entity_id: input_boolean.presence
    from: 'on'
    to: 'off'
  condition: []
  action:
  # Lights
  - service: homeassistant.turn_off
    target:
      entity_id:
        - light.all_lights
        - group.devices_group

  - service: switch.turn_off
    target:
      entity_id:
        - switch.printer_switch

  - wait_template: >-
      {{
        is_state('device_tracker.pc01_lan_router', 'not_home') and
        is_state('device_tracker.pc01_wlan_router', 'not_home') and
        is_state('device_tracker.lap_work_router', 'not_home')
      }}
    continue_on_timeout: true
    timeout: 600

  - if:
      - condition: template
        value_template: >-
          {{
            is_state('device_tracker.pc01_lan_router', 'not_home') and
            is_state('device_tracker.pc01_wlan_router', 'not_home') and
            is_state('device_tracker.lap_work_router', 'not_home')
          }}
    then:
      - service: switch.turn_off
        target:
          entity_id: switch.desk_and_laptop_group

      - if:
          - condition: numeric_state
            entity_id: sensor.3d_printer_switch_energy_power
            below: 40
        then:
          - service: switch.turn_off
            target:
              entity_id:
                - switch.3d_printer_switch
                - switch.3d_printer_usb
