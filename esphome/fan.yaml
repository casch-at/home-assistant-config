substitutions:
  name: "fan"
  ap_ssid: "Fan Fallback Hotspot"

esphome:
  <<: !include .board-config-az-delivery-devkit-v4.yaml
  # Fix for low output signal on transmit gpio after boot
  on_boot:
    then:
      - remote_transmitter.transmit_raw:
          code: [-10]

<<: !include .base-config.yaml

### Receive and Transmit IR
remote_receiver:
  pin:
    number: 25
    mode: INPUT_PULLUP
    # When using a MOSFET to convert the signal to 3.3V than the signal also gets inverted
    # inverted: true
  # Note 1: Use "raw" not "all", otherwise it gets detected as a rc_switch code but transmitting that will produce the wrong code.
  # Note 2: Just press the buttons very shortly while right in front of the receiver to get the shortest yet most accurate result.
  dump: raw
  # Forward received data to onboard MCU (BS84B08A-3/BS84C12A-3, 28 PIN, 5V operation)
  on_raw:
    then:
      - remote_transmitter.transmit_raw:
          code: !lambda |-
            return x;

remote_transmitter:
  pin:
    number: 26
    inverted: true
  carrier_duty_percent: 50%

switch:
  - platform: template
    name: On/Fan Speed
    id: fan_speed_switch
    icon: mdi:fan
    turn_on_action:
      - remote_transmitter.transmit_raw:
          # Just read inverted raw value with remote_receiver, however to remote_transmitter ouput pin must be set to inverted.
          code: [-1260, 403, -1282, 407, -433, 1252, -1260, 404, -1282, 403, -437, 1251, -414, 1251, -414, 1251, -415, 1250, -415, 1250, -1261, 403, -436, 7599, -1262, 403, -1283, 403, -436, 1251, -1261, 403, -1283, 404, -435, 1251, -415, 1249, -416, 1251, -414, 1251, -415, 1250, -1261, 403, -436, 7140, -1260, 404, -1282, 403, -437, 1250, -1260, 404, -1282, 404, -436, 1252, -413, 1251, -414, 1251, -415, 1251, -414, 1251, -1260, 404, -435, 7599, -1262, 403, -1282, 403, -437, 1250, -1261, 403, -1283, 403, -436, 1251, -415, 1251, -415, 1249, -415, 1250, -415, 1250, -1261, 404, -437, 7138, -1261, 403, -1283, 402, -439, 1249, -1261, 402, -1283, 404, -438, 1248, -416, 1249, -416, 1250, -415, 1249, -416, 1250, -1260, 403, -439, 7597, -1261, 403, -1282, 403, -440, 1248, -1261, 402, -1283, 403, -438, 1249, -415, 1250, -415, 1250, -415, 1250, -415, 1250, -1261, 402, -439]
      - script.execute: script_initial_mode

  - platform: template
    name: Mode
    id: fan_mode_switch
    icon: mdi:form-select
    turn_on_action:
      - remote_transmitter.transmit_raw:
          code: [-1283, 402, -1283, 402, -440, 1231, -1278, 402, -1283, 403, -439, 1254, -412, 1227, -438, 1227, -438, 1229, -1281, 403, -438, 1230, -436, 7576, -1283, 401, -1284, 402, -440, 1227, -1282, 402, -1284, 402, -439, 1231, -435, 1226, -439, 1230, -436, 1229, -1279, 405, -438, 1253, -412, 7114, -1282, 403, -1282, 404, -438, 1253, -1256, 403, -1283, 402, -441, 1225, -440, 1228, -437, 1253, -412, 1229, -1279, 404, -439, 1229, -436, 7577, -1282, 402, -1283, 404, -438, 1252, -1257, 402, -1283, 403, -439, 1253, -412, 1253, -413, 1229, -436, 1251, -1258, 401, -441, 1251, -413, 7112, -1284, 402, -1283, 402, -440, 1249, -1259, 403, -1283, 403, -439, 1249, -414, 1251, -415, 1250, -415, 1250, -1260, 403, -439, 1249, -414, 7577, -1284, 402, -1283, 403, -439, 1249, -1260, 403, -1284, 402, -439, 1249, -415, 1250, -415, 1250, -415, 1250, -1262, 402, -439, 1249, -415]
      - script.execute: script_mode

  - platform: template
    name: "Swing"
    id: fan_swing_switch
    icon: mdi:cached
    turn_on_action:
      - remote_transmitter.transmit_raw:
          code: [-1282, 402, -1283, 403, -439, 1251, -1258, 403, -1283, 405, -436, 1252, -413, 1252, -1258, 402, -439, 1251, -414, 1252, -413, 1251, -414, 7603, -1258, 402, -1284, 402, -440, 1228, -1281, 403, -1284, 402, -439, 1250, -414, 1252, -1259, 402, -440, 1250, -414, 1251, -413, 1253, -413, 7116, -1281, 403, -1284, 403, -437, 1251, -1259, 403, -1283, 402, -440, 1250, -413, 1252, -1259, 404, -438, 1250, -414, 1251, -414, 1252, -413, 7579, -1282, 403, -1283, 402, -439, 1250, -1259, 402, -1284, 403, -437, 1251, -414, 1252, -1258, 404, -438, 1228, -436, 1252, -414, 1229, -436, 7114, -1283, 403, -1282, 403, -440, 1250, -1258, 403, -1283, 402, -439, 1228, -436, 1252, -1258, 404, -438, 1251, -413, 1251, -414, 1228, -437, 7602, -1258, 403, -1282, 404, -438, 1227, -1282, 403, -1282, 403, -439, 1251, -414, 1251, -1259, 403, -438, 1251, -414, 1252, -414, 1229, -436, 7114, -1283, 403, -1283, 403, -438, 1252, -1258, 403, -1283, 402, -439, 1252, -413, 1251, -1259, 402, -439, 1252, -413, 1253, -413, 1252, -412, 7578, -1281, 403, -1282, 403, -439, 1226, -1284, 403, -1282, 403, -439, 1230, -436, 1227, -1282, 403, -439, 1229, -438, 1228, -436, 1228, -438]

  - platform: template
    name: Mist
    id: fan_mist_switch
    icon: mdi:water
    turn_on_action:
      - remote_transmitter.transmit_raw:
          code: [-1260, 402, -1284, 403, -438, 1250, -1259, 402, -1284, 402, -1283, 402, -440, 1249, -415, 1249, -415, 1251, -415, 1250, -1260, 403, -1282, 6736, -1261, 402, -1284, 404, -437, 1250, -1260, 402, -1284, 404, -1281, 402, -440, 1249, -415, 1250, -416, 1250, -415, 1249, -1261, 403, -1283, 6251, -1283, 402, -1284, 403, -439, 1249, -1260, 403, -1283, 402, -1284, 402, -440, 1249, -415, 1250, -416, 1249, -416, 1250, -1260, 402, -1284, 6737, -1259, 403, -1283, 404, -438, 1250, -1259, 402, -1284, 403, -1283, 402, -439, 1250, -415, 1251, -414, 1228, -438, 1250, -1260, 402, -1283, 6251, -1282, 401, -1284, 402, -440, 1251, -1258, 404, -1281, 403, -1282, 404, -439, 1227, -439, 1251, -413, 1229, -436, 1224, -1284, 404, -1282, 6713, -1282, 403, -1283, 401, -441, 1252, -1256, 401, -1285, 403, -1283, 403, -438, 1252, -413, 1228, -437, 1228, -437, 1227, -1282, 402, -1283]

  - platform: template
    name: "Off"
    id: fan_off_switch
    icon: mdi:fan-off
    turn_on_action:
      - remote_transmitter.transmit_raw:
          code: [-1281, 404, -1282, 403, -439, 1253, -1256, 402, -1283, 404, -439, 1228, -437, 1229, -436, 1227, -438, 1229, -437, 1252, -413, 1227, -1282, 6754, -1282, 403, -1283, 404, -438, 1228, -1281, 403, -1283, 403, -439, 1228, -437, 1253, -412, 1253, -413, 1253, -412, 1230, -435, 1253, -1257, 6295, -1282, 403, -1283, 402, -440, 1251, -1258, 402, -1283, 404, -438, 1251, -413, 1229, -438, 1227, -438, 1252, -413, 1252, -413, 1230, -1280, 6753, -1281, 402, -1283, 403, -439, 1228, -1281, 403, -1282, 403, -439, 1253, -412, 1228, -437, 1226, -439, 1253, -412, 1230, -435, 1253, -1256, 6291, -1286, 402, -1283, 403, -439, 1227, -1282, 402, -1283, 402, -439, 1228, -438, 1228, -437, 1228, -436, 1227, -440, 1226, -438, 1226, -1282, 6753, -1281, 404, -1282, 402, -440, 1227, -1282, 402, -1283, 403, -439, 1227, -438, 1225, -441, 1225, -439, 1226, -439, 1226, -438, 1225, -1284]
script:
  - id: script_initial_mode
    then:
      - lambda: |
          if (!(id(fan_mode_fan).state || id(fan_mode_night).state || id(fan_mode_tree).state)) {
            id(fan_mode_fan).publish_state(true);
          }

  - id: script_mode
    then:
      - lambda: |
          if (id(fan_speed_low).state || id(fan_speed_mid).state || id(fan_speed_high).state) {
            if (id(fan_mode_fan).state) {
              id(fan_mode_fan).publish_state(false);
              id(fan_mode_tree).publish_state(true);
            } else if (id(fan_mode_tree).state) {
              id(fan_mode_tree).publish_state(false);
              id(fan_mode_night).publish_state(true);
            } else if (id(fan_mode_night).state) {
              id(fan_mode_night).publish_state(false);
              id(fan_mode_fan).publish_state(true);
            }
          }

### Status
binary_sensor:
  # Fan status
  # Speed/On -- default speed is low after power loos
  - platform: remote_receiver
    id: fan_speed_button_pressed
    internal: true
    raw:
      code: [-1260, 403, -1282, 407, -433, 1252, -1260, 404, -1282, 403, -437, 1251, -414, 1251, -414, 1251, -415, 1250, -415, 1250, -1261, 403, -436, 7599, -1262, 403, -1283, 403, -436, 1251, -1261, 403, -1283, 404, -435, 1251, -415, 1249, -416, 1251, -414, 1251, -415, 1250, -1261, 403, -436, 7140, -1260, 404, -1282, 403, -437, 1250, -1260, 404, -1282, 404, -436, 1252, -413, 1251, -414, 1251, -415, 1251, -414, 1251, -1260, 404, -435, 7599, -1262, 403, -1282, 403, -437, 1250, -1261, 403, -1283, 403, -436, 1251, -415, 1251, -415, 1249, -415, 1250, -415, 1250, -1261, 404, -437, 7138, -1261, 403, -1283, 402, -439, 1249, -1261, 402, -1283, 404, -438, 1248, -416, 1249, -416, 1250, -415, 1249, -416, 1250, -1260, 403, -439, 7597, -1261, 403, -1282, 403, -440, 1248, -1261, 402, -1283, 403, -438, 1249, -415, 1250, -415, 1250, -415, 1250, -415, 1250, -1261, 402, -439]
    on_press:
      then:
        - script.execute: script_initial_mode

  - platform: gpio
    pin: 39
    name: Speed Low
    id: fan_speed_low

  - platform: gpio
    pin: 34
    name: Speed Mid
    id: fan_speed_mid

  - platform: gpio
    pin: 35
    name: Speed High
    id: fan_speed_high

  # Mode status -- default mode is fan after power loos
  - platform: remote_receiver
    id: fan_mode_button_pressed
    internal: true
    raw:
      code: [-1283, 402, -1283, 402, -440, 1231, -1278, 402, -1283, 403, -439, 1254, -412, 1227, -438, 1227, -438, 1229, -1281, 403, -438, 1230, -436, 7576, -1283, 401, -1284, 402, -440, 1227, -1282, 402, -1284, 402, -439, 1231, -435, 1226, -439, 1230, -436, 1229, -1279, 405, -438, 1253, -412, 7114, -1282, 403, -1282, 404, -438, 1253, -1256, 403, -1283, 402, -441, 1225, -440, 1228, -437, 1253, -412, 1229, -1279, 404, -439, 1229, -436, 7577, -1282, 402, -1283, 404, -438, 1252, -1257, 402, -1283, 403, -439, 1253, -412, 1253, -413, 1229, -436, 1251, -1258, 401, -441, 1251, -413, 7112, -1284, 402, -1283, 402, -440, 1249, -1259, 403, -1283, 403, -439, 1249, -414, 1251, -415, 1250, -415, 1250, -1260, 403, -439, 1249, -414, 7577, -1284, 402, -1283, 403, -439, 1249, -1260, 403, -1284, 402, -439, 1249, -415, 1250, -415, 1250, -415, 1250, -1262, 402, -439, 1249, -415]
    on_press:
      then:
        - script.execute: script_mode

  - platform: template
    name: Mode Fan
    id: fan_mode_fan

  - platform: template
    name: Mode Night
    id: fan_mode_night

  - platform: template
    name: Mode Tree
    id: fan_mode_tree

  # Swing status
  - platform: gpio
    pin: 32
    name: Swing
    id: fan_swing

  # Mist status
  - platform: gpio
    pin: 36
    name: Mist
    id: fan_mist
